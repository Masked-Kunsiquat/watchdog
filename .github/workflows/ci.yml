name: CI

on:
  push:
    branches: [ master, feat/*, release/* ]
  pull_request:
    branches: [ master ]

jobs:
  shellcheck:
    name: Shellcheck Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run shellcheck on all scripts
        run: |
          # Run shellcheck with exclusions for known false positives
          find . -type f -name "*.sh" -exec shellcheck -x -e SC1091 -e SC2317 {} +

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run unit tests
        run: |
          cd tests
          bash unit-tests.sh

  smoke-tests:
    name: Smoke Tests (ICMP mode)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install agent first
        run: |
          sudo ./scripts/install.sh

      - name: Run smoke tests
        run: |
          cd tests
          sudo bash smoke-test.sh

  tcp-health-check:
    name: TCP Health Check Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install netcat
        run: sudo apt-get update && sudo apt-get install -y netcat-openbsd

      - name: Test TCP mode with real netcat
        run: |
          # Install the agent
          sudo ./scripts/install.sh

          # Configure for TCP mode with Google/Cloudflare HTTPS ports (should be reachable)
          sudo tee /etc/default/netwatch-agent > /dev/null <<'EOF'
          HEALTH_CHECK_MODE="tcp"
          TCP_TARGETS="8.8.8.8:443 1.1.1.1:443"
          MIN_OK=1
          PING_TIMEOUT=2
          CHECK_INTERVAL=5
          DOWN_WINDOW_SECONDS=30
          BOOT_GRACE=5
          DRY_RUN=1
          DISABLE_FILE="/etc/netwatch-agent.disable"
          EOF

          # Start service
          sudo systemctl restart netwatch-agent

          # Wait for boot grace
          sleep 10

          # Check logs for TCP mode activation
          sudo journalctl -u netwatch-agent --no-pager | grep -i "tcp"

          # Verify service is running
          sudo systemctl is-active netwatch-agent

          # Check that probes are succeeding (no WAN down messages)
          if sudo journalctl -u netwatch-agent --no-pager | grep -i "WAN appears down"; then
            echo "ERROR: TCP health checks failing on reachable targets"
            sudo journalctl -u netwatch-agent --no-pager
            exit 1
          fi

          echo "TCP health checks working correctly"

  http-health-check:
    name: HTTP Health Check Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install curl
        run: sudo apt-get update && sudo apt-get install -y curl

      - name: Test HTTP mode with real curl
        run: |
          # Install the agent
          sudo ./scripts/install.sh

          # Configure for HTTP mode with Google/Cloudflare (should return 200)
          sudo tee /etc/default/netwatch-agent > /dev/null <<'EOF'
          HEALTH_CHECK_MODE="http"
          HTTP_TARGETS="https://1.1.1.1 https://www.google.com"
          HTTP_EXPECTED_CODE="200"
          MIN_OK=1
          PING_TIMEOUT=5
          CHECK_INTERVAL=5
          DOWN_WINDOW_SECONDS=30
          BOOT_GRACE=5
          DRY_RUN=1
          DISABLE_FILE="/etc/netwatch-agent.disable"
          EOF

          # Start service
          sudo systemctl restart netwatch-agent

          # Wait for boot grace
          sleep 10

          # Check logs for HTTP mode activation
          sudo journalctl -u netwatch-agent --no-pager | grep -i "http"

          # Verify service is running
          sudo systemctl is-active netwatch-agent

          # Check that probes are succeeding (no WAN down messages)
          if sudo journalctl -u netwatch-agent --no-pager | grep -i "WAN appears down"; then
            echo "ERROR: HTTP health checks failing on reachable targets"
            sudo journalctl -u netwatch-agent --no-pager
            exit 1
          fi

          echo "HTTP health checks working correctly"

  dependency-validation:
    name: Dependency Validation Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test TCP mode without netcat (should fail gracefully)
        run: |
          sudo ./scripts/install.sh

          # Remove netcat if present
          sudo apt-get remove -y netcat-openbsd netcat-traditional || true

          # Configure for TCP mode
          sudo tee /etc/default/netwatch-agent > /dev/null <<'EOF'
          HEALTH_CHECK_MODE="tcp"
          TCP_TARGETS="8.8.8.8:443"
          MIN_OK=1
          DRY_RUN=1
          EOF

          # Try to start service - should fail with clear error
          if sudo systemctl start netwatch-agent 2>&1; then
            sleep 2
            # Check for error message in logs
            if sudo journalctl -u netwatch-agent --no-pager | grep -i "netcat.*not found"; then
              echo "✓ TCP mode correctly detected missing netcat dependency"
            else
              echo "ERROR: TCP mode did not report missing netcat"
              sudo journalctl -u netwatch-agent --no-pager
              exit 1
            fi
          fi

      - name: Test HTTP mode without curl (should fail gracefully)
        run: |
          # Remove curl if present
          sudo apt-get remove -y curl || true

          # Configure for HTTP mode
          sudo tee /etc/default/netwatch-agent > /dev/null <<'EOF'
          HEALTH_CHECK_MODE="http"
          HTTP_TARGETS="https://www.google.com"
          HTTP_EXPECTED_CODE="200"
          MIN_OK=1
          DRY_RUN=1
          EOF

          # Try to start service - should fail with clear error
          if sudo systemctl restart netwatch-agent 2>&1; then
            sleep 2
            # Check for error message in logs
            if sudo journalctl -u netwatch-agent --no-pager | grep -i "curl.*not found"; then
              echo "✓ HTTP mode correctly detected missing curl dependency"
            else
              echo "ERROR: HTTP mode did not report missing curl"
              sudo journalctl -u netwatch-agent --no-pager
              exit 1
            fi
          fi

  integration-test:
    name: Integration Test (ICMP + fping)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install fping
        run: sudo apt-get update && sudo apt-get install -y fping

      - name: Test with fping (all targets reachable)
        run: |
          sudo ./scripts/install.sh

          # Configure with short timings for fast test
          sudo tee /etc/default/netwatch-agent > /dev/null <<'EOF'
          HEALTH_CHECK_MODE="icmp"
          TARGETS="8.8.8.8 1.1.1.1 9.9.9.9"
          MIN_OK=2
          PING_COUNT=2
          PING_TIMEOUT=2
          CHECK_INTERVAL=5
          DOWN_WINDOW_SECONDS=30
          BOOT_GRACE=5
          USE_FPING="yes"
          DRY_RUN=1
          DISABLE_FILE="/etc/netwatch-agent.disable"
          EOF

          # Start service
          sudo systemctl restart netwatch-agent

          # Wait for boot grace + a few checks
          sleep 15

          # Verify fping is being used
          if ! sudo journalctl -u netwatch-agent --no-pager | grep -i "using fping"; then
            echo "ERROR: fping not being used despite USE_FPING=yes"
            sudo journalctl -u netwatch-agent --no-pager
            exit 1
          fi

          # Check that probes are succeeding
          if sudo journalctl -u netwatch-agent --no-pager | grep -i "WAN appears down"; then
            echo "ERROR: WAN down detected on reachable targets"
            sudo journalctl -u netwatch-agent --no-pager
            exit 1
          fi

          echo "✓ fping integration test passed"

      - name: Test with unreachable targets (should detect outage)
        run: |
          # Block ICMP to simulate outage
          sudo iptables -I OUTPUT -p icmp -d 8.8.8.8 -j DROP
          sudo iptables -I OUTPUT -p icmp -d 1.1.1.1 -j DROP
          sudo iptables -I OUTPUT -p icmp -d 9.9.9.9 -j DROP

          # Wait for checks to detect outage
          sleep 20

          # Verify WAN down was detected
          if ! sudo journalctl -u netwatch-agent --no-pager | grep -i "WAN appears down"; then
            echo "ERROR: Failed to detect simulated outage"
            sudo journalctl -u netwatch-agent --no-pager
            exit 1
          fi

          echo "✓ Outage detection test passed"

          # Cleanup
          sudo iptables -D OUTPUT -p icmp -d 8.8.8.8 -j DROP || true
          sudo iptables -D OUTPUT -p icmp -d 1.1.1.1 -j DROP || true
          sudo iptables -D OUTPUT -p icmp -d 9.9.9.9 -j DROP || true

  install-uninstall:
    name: Install/Uninstall Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test fresh install
        run: |
          sudo ./scripts/install.sh

          # Verify files exist
          test -f /usr/local/sbin/netwatch-agent.sh
          test -f /etc/default/netwatch-agent
          test -f /etc/systemd/system/netwatch-agent.service

          # Verify service is enabled and running
          sudo systemctl is-enabled netwatch-agent
          sudo systemctl is-active netwatch-agent

          echo "✓ Fresh install successful"

      - name: Test upgrade (reinstall)
        run: |
          # Modify config to ensure preservation
          echo "# Test comment" | sudo tee -a /etc/default/netwatch-agent

          # Reinstall
          sudo ./scripts/install.sh

          # Verify config was preserved
          if ! grep "Test comment" /etc/default/netwatch-agent; then
            echo "ERROR: Config was not preserved during upgrade"
            exit 1
          fi

          echo "✓ Upgrade test successful"

      - name: Test uninstall
        run: |
          sudo ./scripts/uninstall.sh --keep-config

          # Verify service is stopped and disabled
          if sudo systemctl is-active netwatch-agent 2>/dev/null; then
            echo "ERROR: Service still running after uninstall"
            exit 1
          fi

          # Verify files removed
          if test -f /usr/local/sbin/netwatch-agent.sh; then
            echo "ERROR: Agent script not removed"
            exit 1
          fi

          # Verify config was preserved (--keep-config flag)
          if ! test -f /etc/default/netwatch-agent; then
            echo "ERROR: Config was removed despite --keep-config"
            exit 1
          fi

          echo "✓ Uninstall test successful"
